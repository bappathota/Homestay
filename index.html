<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BappaThota Homestay</title>

<meta name="theme-color" content="#2980b9">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(rgba(0,0,0,.45),rgba(0,0,0,.45)),
  url("https://raw.githubusercontent.com/bappathota/Homestay/main/Image.jpeg");
  background-size:cover;
}
h1{color:#fff;text-align:center;margin:20px 0}

.container{
  background:#fff;
  max-width:960px;
  margin:auto;
  padding:20px;
  border-radius:14px;
}

button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.primary{background:#2980b9;color:#fff}
.success{background:#27ae60;color:#fff}
.warn{background:#e74c3c;color:#fff}
.edit{background:#f39c12;color:#fff}

.hidden{display:none}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  padding:10px;
  border:1px solid #ddd;
  text-align:center;
}
.booked{color:red;font-weight:600}
.available{color:green;font-weight:600}

/* MODALS */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal-overlay.show{display:flex}
.modal{
  background:#fff;
  padding:20px;
  border-radius:14px;
  width:90%;
  max-width:380px;
  text-align:center;
}
.modal input{
  width:100%;
  padding:10px;
  margin:6px 0;
}
.modal-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>BappaThota Homestay</h1>

<div class="container">

<button id="adminLoginBtn" class="primary">üîê Admin Login</button>
<button id="addBookingBtn" class="primary hidden">‚ûï Add Booking</button>
<button id="calendarBtn" class="primary">üìÖ Calendar</button>

<!-- ADD BOOKING -->
<div id="addBookingForm" class="hidden">
  <h3>Add Booking</h3>
  <input id="guest" placeholder="Guest Name">
  <input id="phone" placeholder="Phone (10 digits)">
  <input id="guests" type="number" min="1" max="4" placeholder="Guests (max 4)">
  <select id="room"></select>
  <input type="date" id="checkin">
  <input type="date" id="checkout">
  <button class="success" onclick="addBooking()">Confirm</button>
</div>

<!-- TABLE -->
<h3 id="tableTitle">Today's Availability</h3>
<table>
<thead>
<tr>
<th>Room</th>
<th>Status</th>
<th>Guest</th>
<th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<!-- CALENDAR -->
<div id="calendarWrapper" class="hidden">
  <h3 id="monthLabel"></h3>
  <button onclick="changeMonth(-1)">‚¨Ö</button>
  <button onclick="changeMonth(1)">‚û°</button>
  <div id="calendar" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px"></div>
</div>

</div>

<!-- ADMIN LOGIN -->
<div id="adminModal" class="modal-overlay">
  <div class="modal">
    <h3>Admin Login</h3>
    <input id="adminPin" type="password" maxlength="4" placeholder="4-digit PIN">
    <div id="adminError" style="color:red"></div>
    <div class="modal-actions">
      <button class="warn" onclick="closeAdmin()">Cancel</button>
      <button class="success" onclick="verifyAdmin()">Login</button>
    </div>
  </div>
</div>

  <!-- VIEW BOOKING MODAL -->
<div id="viewModal" class="modal-overlay">
  <div class="modal">
    <h3>Booking Details</h3>

    <div style="text-align:left;font-size:14px;line-height:1.6">
      <strong>Guest Name:</strong> <span id="viewGuest"></span><br>
      <strong>Phone:</strong> <span id="viewPhone"></span><br>
      <strong>No. of Guests:</strong> <span id="viewGuests"></span><br>
      <strong>Room:</strong> <span id="viewRoom"></span><br>
      <strong>Check-in:</strong> <span id="viewCheckin"></span><br>
      <strong>Check-out:</strong> <span id="viewCheckout"></span><br>
      <strong>Status:</strong> <span id="viewStatus"></span>
    </div>

    <div class="modal-actions" style="margin-top:15px">
      <button class="confirm-btn" onclick="closeViewModal()">Close</button>
    </div>
  </div>
</div>


<!-- EDIT MODAL -->
<div id="editModal" class="modal-overlay">
  <div class="modal">
    <h3>Edit Booking</h3>
    <input id="editGuest">
    <input id="editPhone">
    <input id="editGuests" type="number" min="1" max="4">
    <input id="editCheckin" type="date">
    <input id="editCheckout" type="date">
    <div class="modal-actions">
      <button class="warn" onclick="closeEdit()">Cancel</button>
      <button class="success" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>

<!-- CANCEL MODAL -->
<div id="cancelModal" class="modal-overlay">
  <div class="modal">
    <h3>Cancel Booking?</h3>
    <div class="modal-actions">
      <button onclick="closeCancel()">No</button>
      <button class="warn" onclick="confirmCancel()">Yes</button>
    </div>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyNAx2Tuc3tn2pLg3OVBJ2Cu5iRPn7EnQ-QrscSUC1JQ9s6hgpTecJiZQuS4M3TYRCJ3g/exec";
const TOTAL_ROOMS=2;

let adminUnlocked=false;
let editData=null;
let cancelId=null;

const $=id=>document.getElementById(id);
const toDate=d=>new Date(d).toISOString().split("T")[0];

/* ADMIN */
$("adminLoginBtn").onclick=()=>$("adminModal").classList.add("show");
function closeAdmin(){$("adminModal").classList.remove("show")}
function verifyAdmin(){
  fetch(`${API_URL}?action=verifyAdmin&pin=${$("adminPin").value}`)
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){$("adminError").textContent="Invalid PIN";return;}
    adminUnlocked=true;
    $("adminLoginBtn").classList.add("hidden");
    $("addBookingBtn").classList.remove("hidden");
    closeAdmin();
    loadToday();
  });
}

/* INIT */
function initRooms(){
  $("room").innerHTML="";
  for(let i=1;i<=TOTAL_ROOMS;i++)
    $("room").innerHTML+=`<option>${i}</option>`;
}

/* ADD */
$("addBookingBtn").onclick=()=>{
  if(!adminUnlocked)return $("adminModal").classList.add("show");
  $("addBookingForm").classList.toggle("hidden");
};

async function addBooking(){
  if(!/^\d{10}$/.test($("phone").value))
    return alert("Phone must be 10 digits");

  if($("guests").value > 4)
    return alert("Max 4 guests allowed");

  if(!$("guest").value || !$("checkin").value || !$("checkout").value)
    return alert("All fields are required");

  const fd = new URLSearchParams({
    action: "add",              // ‚úÖ THIS WAS MISSING
    guest_name: $("guest").value,
    phone: $("phone").value,
    no_of_guests: $("guests").value,
    room_no: $("room").value,
    check_in: $("checkin").value,
    check_out: $("checkout").value
  });

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: fd
    });

    const result = await res.json();

    if (!result.success) {
      alert(result.message || "Failed to add booking");
      return;
    }

    alert("Booking added successfully");

    // reset form
    $("addBookingForm").classList.add("hidden");
    $("guest").value = "";
    $("phone").value = "";
    $("guests").value = "";
    $("checkin").value = "";
    $("checkout").value = "";

    loadToday(); // refresh table

  } catch (err) {
    alert("Network error while adding booking");
    console.error(err);
  }
}

/* LOAD */
async function loadAvailability(date){
  const data=await fetch(API_URL).then(r=>r.json());
  $("list").innerHTML="";
  for(let i=1;i<=TOTAL_ROOMS;i++){
    const b=data.find(x=>x.room_no==i&&x.status==="Booked"&&date>=toDate(x.check_in)&&date<=toDate(x.check_out));
    let action = "-";

if (b) {
  // View is ALWAYS visible
  action = `
    <button class="primary" onclick="viewBooking('${b.booking_id}')">View</button>
  `;

  // Edit & Cancel ONLY for admin
  if (adminUnlocked) {
    action += `
      <button class="edit" onclick="editBooking('${b.booking_id}')">Edit</button>
      <button class="warn" onclick="openCancel('${b.booking_id}')">Cancel</button>
    `;
  }
}

    $("list").innerHTML+=`
    <tr>
      <td>Room ${i}</td>
      <td class="${b?'booked':'available'}">${b?'Booked':'Available'}</td>
      <td>${b?.guest_name||'-'}</td>
      <td>${action}</td>
    </tr>`;
  }
}
function loadToday(){loadAvailability(toDate(new Date()));}
function viewBooking(id) {
  fetch(API_URL)
    .then(r => r.json())
    .then(data => {
      const b = data.find(x => x.booking_id === id);
      if (!b) {
        alert("Booking not found");
        return;
      }

      document.getElementById("viewGuest").textContent = b.guest_name || "-";
      document.getElementById("viewPhone").textContent = b.phone || "-";
      document.getElementById("viewGuests").textContent = b.no_of_guests || "-";
      document.getElementById("viewRoom").textContent = "Room " + b.room_no;
      document.getElementById("viewCheckin").textContent = formatDate(b.check_in);
      document.getElementById("viewCheckout").textContent = formatDate(b.check_out);
      document.getElementById("viewStatus").textContent = b.status || "-";

      document.getElementById("viewModal").classList.add("show");
    });
}

function closeViewModal() {
  document.getElementById("viewModal").classList.remove("show");
}

function formatDate(d) {
  return new Date(d).toLocaleDateString();
}

/* EDIT */
function editBooking(id){
  fetch(API_URL).then(r=>r.json()).then(data=>{
    editData=data.find(x=>x.booking_id===id);
    if(!editData)return;
    $("editGuest").value=editData.guest_name;
    $("editPhone").value=editData.phone;
    $("editGuests").value=editData.no_of_guests;
    $("editCheckin").value=toDate(editData.check_in);
    $("editCheckout").value=toDate(editData.check_out);
    $("editModal").classList.add("show");
  });
}
function closeEdit(){$("editModal").classList.remove("show")}
function saveEdit(){
  const fd=new URLSearchParams({
    action:"update",
    booking_id:editData.booking_id,
    guest_name:$("editGuest").value,
    phone:$("editPhone").value,
    no_of_guests:$("editGuests").value,
    room_no:editData.room_no,
    check_in:$("editCheckin").value,
    check_out:$("editCheckout").value
  });
  fetch(API_URL,{method:"POST",body:fd}).then(()=>{
    closeEdit();loadToday();
  });
}

/* CANCEL */
function openCancel(id){cancelId=id;$("cancelModal").classList.add("show")}
function closeCancel(){$("cancelModal").classList.remove("show")}
function confirmCancel(){
  fetch(API_URL,{method:"POST",body:new URLSearchParams({action:"cancel",booking_id:cancelId})})
  .then(()=>{closeCancel();loadToday();});
}

/* CALENDAR */
let cm=new Date().getMonth(),cy=new Date().getFullYear();
$("calendarBtn").onclick=()=>{$("calendarWrapper").classList.toggle("hidden");renderCalendar();}
function changeMonth(d){cm+=d;if(cm<0){cm=11;cy--}if(cm>11){cm=0;cy++}renderCalendar()}
async function renderCalendar(){
  $("calendar").innerHTML="";
  $("monthLabel").textContent=new Date(cy,cm).toLocaleString("default",{month:"long",year:"numeric"});
  const data=await fetch(API_URL).then(r=>r.json());
  const days=new Date(cy,cm+1,0).getDate();
  for(let d=1;d<=days;d++){
    const date=`${cy}-${String(cm+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    let html="";
    for(let r=1;r<=TOTAL_ROOMS;r++){
      const b=data.find(x=>x.room_no==r&&date>=toDate(x.check_in)&&date<=toDate(x.check_out));
      html+=`<div>Room ${r}: ${b?'‚ùå':'‚úÖ'}</div>`;
    }
    $("calendar").innerHTML+=`<div style="border:1px solid #ccc;padding:6px">${d}<br>${html}</div>`;
  }
}

/* START */
document.addEventListener("DOMContentLoaded",()=>{
  initRooms();
  loadToday();
});
</script>

</body>
</html>



