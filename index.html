<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BappaThota Homestay</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#2c2c2c;
}
h1{color:white;text-align:center;margin:20px 0;}

.container{
  background:white;
  max-width:1000px;
  margin:auto;
  padding:20px;
  border-radius:14px;
}

button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.primary{background:#2980b9;color:white;}
.success{background:#27ae60;color:white;}
.warn{background:#f39c12;color:white;}
.danger{background:#e74c3c;color:white;}

.hidden{display:none;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
.booked{color:red;font-weight:600;}
.available{color:green;font-weight:600;}

/* modal */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal{
  background:white;
  padding:20px;
  border-radius:12px;
  width:90%;
  max-width:350px;
}
</style>
</head>

<body>

<h1>BappaThota Homestay</h1>

<!-- ADMIN MODAL -->
<div id="adminModal" class="modal-bg">
  <div class="modal">
    <h3>Admin Login</h3>
    <input id="adminPin" type="password" maxlength="4" placeholder="4 digit PIN" style="width:100%;padding:10px;">
    <p id="adminErr" style="color:red"></p>
    <button class="success" onclick="verifyAdmin()">Login</button>
    <button class="danger" onclick="closeAdmin()">Cancel</button>
  </div>
</div>

<div class="container">

<button id="adminBtn" class="primary">üîê Admin Login</button>
<button id="addBtn" class="primary hidden">‚ûï Add / Edit Booking</button>

<!-- FORM -->
<div id="formBox" class="hidden">
  <h3 id="formTitle">Add Booking</h3>
  <input id="guest" placeholder="Guest Name"><br>
  <input id="phone" placeholder="Phone (10 digits)"><br>
  <input id="guests" type="number" min="1" max="4" placeholder="Guests (max 4)"><br>
  <select id="room"></select><br>
  <label>Check-in</label>
  <input type="date" id="checkin"><br>
  <label>Check-out</label>
  <input type="date" id="checkout"><br><br>
  <button class="success" onclick="saveBooking()">Save</button>
</div>

<h3 id="title">Today's Availability</h3>
<table>
<thead>
<tr>
<th>Room</th>
<th>Status</th>
<th>Guest</th>
<th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<h3 style="margin-top:30px;">üìÖ Monthly Calendar</h3>
<div id="calendar"></div>

</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyNAx2Tuc3tn2pLg3OVBJ2Cu5iRPn7EnQ-QrscSUC1JQ9s6hgpTecJiZQuS4M3TYRCJ3g/exec";
const ROOMS=2;

let admin=false;
let editingId=null;

// UI refs
const adminModal=document.getElementById("adminModal");
const addBtn=document.getElementById("addBtn");
const formBox=document.getElementById("formBox");
const list=document.getElementById("list");

// admin
document.getElementById("adminBtn").onclick=()=>adminModal.style.display="flex";
function closeAdmin(){adminModal.style.display="none";}
function verifyAdmin(){
  const pin=document.getElementById("adminPin").value;
  fetch(`${API_URL}?action=verifyAdmin&pin=${pin}`)
  .then(r=>r.json())
  .then(res=>{
    if(!res.success){
      document.getElementById("adminErr").innerText="Invalid PIN";
      return;
    }
    admin=true;
    addBtn.classList.remove("hidden");
    adminModal.style.display="none";
    loadToday();
  });
}

// form
addBtn.onclick=()=>{
  editingId=null;
  document.getElementById("formTitle").innerText="Add Booking";
  formBox.classList.toggle("hidden");
};

function initRooms(){
  const r=document.getElementById("room");
  for(let i=1;i<=ROOMS;i++) r.innerHTML+=`<option value="${i}">Room ${i}</option>`;
}

function dateOnly(d){return new Date(d).toISOString().split("T")[0];}

// load table
async function loadAvailability(date){
  const data=await fetch(API_URL).then(r=>r.json());
  list.innerHTML="";
  for(let i=1;i<=ROOMS;i++){
    const b=data.find(x=>x.room_no==i && date>=dateOnly(x.check_in) && date<=dateOnly(x.check_out));
    let action="-";
    if(admin && b){
      action=`
        <button class="warn" onclick="editBooking('${b.booking_id}')">Edit</button>
        <button class="danger" onclick="cancelBooking('${b.booking_id}')">Cancel</button>`;
    }
    list.innerHTML+=`
    <tr>
      <td>Room ${i}</td>
      <td class="${b?'booked':'available'}">${b?'Booked':'Available'}</td>
      <td>${b?.guest_name||'-'}</td>
      <td>${action}</td>
    </tr>`;
  }
}

function loadToday(){
  loadAvailability(new Date().toISOString().split("T")[0]);
}

// add / edit
async function editBooking(id){
  const data=await fetch(API_URL).then(r=>r.json());
  const b=data.find(x=>x.booking_id===id);
  editingId=id;

  guest.value=b.guest_name;
  phone.value=b.phone;
  guests.value=b.no_of_guests;
  room.value=b.room_no;
  checkin.value=dateOnly(b.check_in);
  checkout.value=dateOnly(b.check_out);

  document.getElementById("formTitle").innerText="Edit Booking";
  formBox.classList.remove("hidden");
}

async function saveBooking(){
  if(!/^\d{10}$/.test(phone.value)) return alert("Invalid phone");
  if(guests.value>4) return alert("Max 4 guests");

  const payload={
    guest_name:guest.value,
    phone:phone.value,
    no_of_guests:guests.value,
    room_no:room.value,
    check_in:checkin.value,
    check_out:checkout.value
  };
  if(editingId){
    payload.action="update";
    payload.booking_id=editingId;
  }

  const res=await fetch(API_URL,{method:"POST",body:new URLSearchParams(payload)});
  const r=await res.json();
  if(!r.success) return alert("Failed");

  alert(editingId?"Updated":"Added");
  formBox.classList.add("hidden");
  editingId=null;
  loadToday();
}

function cancelBooking(id){
  if(!confirm("Cancel booking?"))return;
  fetch(API_URL,{method:"POST",body:new URLSearchParams({action:"cancel",booking_id:id})})
  .then(()=>loadToday());
}

// calendar
async function renderCalendar(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const data=await fetch(API_URL).then(r=>r.json());
  const d=new Date(),y=d.getFullYear(),m=d.getMonth();
  const last=new Date(y,m+1,0).getDate();

  for(let day=1;day<=last;day++){
    const ds=`${y}-${String(m+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
    let html="";
    for(let r=1;r<=ROOMS;r++){
      const b=data.find(x=>x.room_no==r && ds>=dateOnly(x.check_in)&&ds<=dateOnly(x.check_out));
      html+=`Room ${r}: ${b?"‚ùå":"‚úÖ"}<br>`;
    }
    cal.innerHTML+=`<div style="border:1px solid #ddd;padding:6px;margin:4px">${day}<br>${html}</div>`;
  }
}

// init
initRooms();
loadToday();
renderCalendar();
</script>

</body>
</html>
