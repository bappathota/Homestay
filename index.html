<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BappaThota Homestay ‚Äì Booking Tracker</title>

<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#2980b9" />
<link rel="apple-touch-icon" href="icon-192.png" />

<style>
body {
  margin: 0;
  font-family: system-ui, Arial;
  background: linear-gradient(rgba(0,0,0,.45),rgba(0,0,0,.45)),
    url("https://raw.githubusercontent.com/bappathota/Homestay/main/bappathota_Background.jpeg");
  background-size: cover;
}

h1 { text-align:center; color:white; margin:20px 0; }

.container {
  background:white;
  max-width:900px;
  margin:20px auto;
  padding:20px;
  border-radius:14px;
}

button {
  padding:10px 14px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}

.primary { background:#2980b9; color:white; }
.success { background:#27ae60; color:white; }
.warn { background:#e74c3c; color:white; }
.edit { background:#f39c12; color:white; }

.add-booking { display:none; margin-top:10px; }
.add-booking.show { display:block; }

input, select {
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:6px;
  border:1px solid #ccc;
}

table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { border:1px solid #ddd; padding:8px; text-align:center; }
.available { color:green; }
.booked { color:red; }

/* ===== MODAL ===== */
.modal-overlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal-overlay.show { display:flex; }

.modal {
  background:white;
  padding:20px;
  border-radius:12px;
  width:90%;
  max-width:360px;
  text-align:center;
}
.modal-actions { display:flex; gap:10px; margin-top:15px; }
.modal-error { color:red; min-height:18px; }
</style>
</head>

<body>

<!-- ===== ADMIN LOGIN MODAL ===== -->
<div id="adminModal" class="modal-overlay">
  <div class="modal">
    <h3>Admin Login</h3>
    <input id="adminPin" type="password" maxlength="4" placeholder="4-digit PIN" />
    <div id="adminError" class="modal-error"></div>
    <div class="modal-actions">
      <button class="warn" onclick="closeAdminModal()">Cancel</button>
      <button class="success" onclick="verifyAdmin()">Login</button>
    </div>
  </div>
</div>

<!-- ===== CANCEL CONFIRM MODAL ===== -->
<div id="cancelModal" class="modal-overlay">
  <div class="modal">
    <h3>Cancel Booking</h3>
    <p>Are you sure you want to cancel this booking?</p>
    <div class="modal-actions">
      <button class="primary" onclick="closeCancelModal()">No</button>
      <button class="warn" onclick="confirmCancel()">Yes, Cancel</button>
    </div>
  </div>
</div>

<h1>BappaThota Homestay</h1>

<div class="container">

<button id="adminLoginBtn" class="primary" onclick="openAdminModal()">üîê Admin Login</button>

<button id="addBookingBtn" class="primary" style="display:none;">‚ûï Add Booking</button>

<div id="addBookingForm" class="add-booking">
  <input id="guest" placeholder="Guest Name" />
  <input id="phone" placeholder="Phone (10 digits)" maxlength="10" />
  <input id="guests" type="number" min="1" max="4" placeholder="Guests (max 4)" />
  <select id="room"></select>
  <input type="date" id="checkin" />
  <input type="date" id="checkout" />
  <button class="success" onclick="addBooking()">Confirm Booking</button>
</div>

<h3>Today's Availability</h3>

<table>
<thead>
<tr>
  <th>Room</th>
  <th>Status</th>
  <th>Guest</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyNAx2Tuc3tn2pLg3OVBJ2Cu5iRPn7EnQ-QrscSUC1JQ9s6hgpTecJiZQuS4M3TYRCJ3g/exec";
const TOTAL_ROOMS = 2;

let adminUnlocked = false;
let cancelBookingId = null;

const guest = document.getElementById("guest");
const phone = document.getElementById("phone");
const guests = document.getElementById("guests");
const room = document.getElementById("room");
const checkin = document.getElementById("checkin");
const checkout = document.getElementById("checkout");
const list = document.getElementById("list");

/* ===== ADMIN ===== */
function openAdminModal() {
  document.getElementById("adminModal").classList.add("show");
}
function closeAdminModal() {
  document.getElementById("adminModal").classList.remove("show");
}
function verifyAdmin() {
  const pin = document.getElementById("adminPin").value;
  fetch(`${API_URL}?action=verifyAdmin&pin=${pin}`)
    .then(r=>r.json())
    .then(res=>{
      if(!res.success){
        document.getElementById("adminError").textContent="Invalid PIN";
        return;
      }
      adminUnlocked=true;
      sessionStorage.setItem("adminUnlocked","1");
      document.getElementById("addBookingBtn").style.display="block";
      closeAdminModal();
      loadToday();
    });
}

/* ===== ADD BOOKING ===== */
document.getElementById("addBookingBtn").onclick=()=>{
  document.getElementById("addBookingForm").classList.toggle("show");
};

function initRooms(){
  room.innerHTML="";
  for(let i=1;i<=TOTAL_ROOMS;i++)
    room.innerHTML+=`<option value="${i}">Room ${i}</option>`;
}

async function addBooking(){
  if(!/^\d{10}$/.test(phone.value)) return alert("Invalid phone");
  if(guests.value>4) return alert("Max 4 guests");

  const data=new URLSearchParams({
    guest_name:guest.value,
    phone:phone.value,
    no_of_guests:guests.value,
    room_no:room.value,
    check_in:checkin.value,
    check_out:checkout.value
  });

  const res=await fetch(API_URL,{method:"POST",body:data});
  const r=await res.json();
  if(!r.success) return alert(r.message);

  alert("Booking added");
  document.getElementById("addBookingForm").classList.remove("show");
  loadToday();
}

/* ===== LOAD AVAILABILITY ===== */
function toDateOnly(d){return new Date(d).toISOString().split("T")[0];}

async function loadToday(){
  const data=await fetch(API_URL).then(r=>r.json());
  list.innerHTML="";

  const today=new Date().toISOString().split("T")[0];

  for(let i=1;i<=TOTAL_ROOMS;i++){
    const b=data.find(x=>x.room_no==i &&
      today>=toDateOnly(x.check_in)&&today<=toDateOnly(x.check_out));

    let action="-";
    if(adminUnlocked && b){
      action=`
      <button class="edit" onclick="editBooking('${b.booking_id}')">Edit</button>
      <button class="warn" onclick="openCancelModal('${b.booking_id}')">Cancel</button>`;
    }

    list.innerHTML+=`
    <tr>
      <td>Room ${i}</td>
      <td class="${b?'booked':'available'}">${b?'Booked':'Available'}</td>
      <td>${b?.guest_name||'-'}</td>
      <td>${action}</td>
    </tr>`;
  }
}

/* ===== EDIT ===== */
function editBooking(id){
  const name=prompt("Guest Name");
  if(!name) return;

  const data=new URLSearchParams({
    action:"update",
    booking_id:id,
    guest_name:name
  });

  fetch(API_URL,{method:"POST",body:data})
    .then(r=>r.json())
    .then(()=>loadToday());
}

/* ===== CANCEL ===== */
function openCancelModal(id){
  cancelBookingId=id;
  document.getElementById("cancelModal").classList.add("show");
}
function closeCancelModal(){
  cancelBookingId=null;
  document.getElementById("cancelModal").classList.remove("show");
}
function confirmCancel(){
  if(!cancelBookingId) return;

  const data=new URLSearchParams({
    action:"cancel",
    booking_id:cancelBookingId
  });

  fetch(API_URL,{method:"POST",body:data})
    .then(r=>r.json())
    .then(()=>{
      closeCancelModal();
      loadToday();
    });
}

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded",()=>{
  initRooms();
  loadToday();
  if(sessionStorage.getItem("adminUnlocked")==="1"){
    adminUnlocked=true;
    document.getElementById("addBookingBtn").style.display="block";
  }
});
</script>

</body>
</html>
